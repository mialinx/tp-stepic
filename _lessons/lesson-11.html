---
num: 11
title: Реляционные базы данных
description: "Работа с СУБД. Реляционная модель данных. Проектирование баз данных. Работа с СУБД в Python. Работа с СУБД в Django. Понятие ORM, модели Django. Описание таблиц и связей в модели Django. Типы полей в моделях."
---

<section class="slide shout">
    <div>
        <h2>Реляционные базы данных</h2>
    </div>
</section>

<section class="slide">
    <div>
        <h2>Решаемые проблемы</h2>
        <ul>
            <li>Структура хранения</li>
            <li>Эффективный поиск данных</li>
            <li>Управление памятью</li>
            <li>Совместный доступ к данным</li>
            <li>Атомарные операции - транзакции</li>
            <li>Язык управления базой и данными - <b>SQL</b></li>
        </ul>
    </div>
</section>

<section class="slide">
    <div>
        <h2>Реляционная модель данных</h2>
        <p>Данные хранятся в виде таблиц. У каждой таблицы фиксированное число столбцов. Все данные в столбце одного типа.</p>
        <img src="{{ site.pictures_url }}/lesson-11/table.png" class="center">
    </div>
</section>

<section class="slide">
    <div>
        <h2>Проектирование базы данных</h2>
        <p>Основная задача проектирования - сокращение избыточности и дублирования данных.</p>
        <p>Существуют формальные правила проверки схемы базы данных на &laquo;правильность&raquo; - <b>нормальные формы</b> базы данных.</p>
    </div>
</section>

<section class="slide">
    <div>
        <h2>Проектирование на практике</h2>
        <ul>
            <li>Логическое разделение сущностей</li>
            <li>Выделение синтетических первичных ключей</li>
            <li>Связи 1:N, N:1 реализуются через внешний ключ</li>
            <li>Связи N:M реализуются через промежуточную таблицу</li>
            <li>Атрибут с фиксированным числом значений – внешняя таблица либо поле типа enum</li>
        </ul>
    </div>
</section>

<section class="slide shout">
    <div>
        <h2>Базы данных в Python</h2>
    </div>
</section>

<section class="slide">
    <div>
        <h2>Подключение к базе</h2>
        <p>Полное интерфейса для работы с СУБД в <a href="https://www.python.org/dev/peps/pep-0249/">PEP-0249</a></p>
        <script type="snippet" lang="python">
        import MySQLdb
        db = MySQLdb.connect(host="localhost", user="joe",
                            passwd="moonpie", db="thangs")
        cursor = db.cursor()
        # запросы с использованием cursor
        db.commit()
        db.close()
        </script>
    </div>
</section>

<section class="slide">
    <div>
        <h2>Выполнение запросов</h2>
        <script type="snippet" lang="python">
            cursor.execute("""
               update users set age = age + 1 where name = %s
            """, (name,))

            cursor.execute("select * from users")
            users = cursor.fetchall()

            cursor.execute("""
                select * from users where name = %s
            """, (name,))
            user = cursor.fetchone()
        </script>
    </div>
</section>

<section class="slide">
    <div>
        <h2>Вставка многих записей</h2>
        <script type="snippet" lang="python">
            cursor.executemany(
                "INSERT INTO users (name, age) VALUES (%s, %s)",
                [
                    ("Igor", 18 ),
                    ("Petr", 16 ),
                    ("Dasha", 17 )
                ]
            )
            db.commit()
            db.close()
        </script>
    </div>
</section>

<section class="slide">
    <div>
        <h2>Placeholders</h2>
        <script type="snippet" lang="python">
            email = "' OR '1'='1"
            cursor.execute(
                "SELECT * FROM users WHERE email = '" + email + "'"
            )
        </script>
        <script type="snippet" lang="python">
            cursor.execute(
                "SELECT * FROM users WHERE email = '%s'", 
                email
            )
        </script>
    </div>
</section>

<section class="slide shout">
    <div>
        <h2>Базы данных в Django</h2>
    </div>
</section>

<section class="slide">
    <div>
        <h2>Прямой доступ к базе</h2>
        <script type="snippet" lang="python">
            from django.db import connection, connections

            cur = connection.cursor()
            cur.execute("select * from tbl limit 10")

            default_cur = connections['default'].cursor()
            default_cur.execute("select * from tbl2 limit 10")
            another_cur = connections['another'].cursor()
            another_cur.execute("select * from tbl2 limit 10")
        </script>
    </div>
</section>

<section class="slide">
    <div>
        <h2>Полезные утилиты</h2>
        <ul>
            <li><code>./manage.py validate</code> - проверить структуру моделей</li>
            <li><code>./manage.py syncdb</code> - создать таблицы в базе (1 раз)</li>
            <li><code>./manage.py shell</code> - запустить python shell</li>
            <li><code>./manage.py dbshell</code> - запустить клиент базы данных</li>
        </ul>
    </div>
</section>

<section class="slide">
    <div>
        <h2>Django Models</h2>
        <p><b>ORM</b> - Object relational mapping - библиотек предоставляющая объектно-ориентированный интерфейс к 
            реляционной базе данных. <b>Django Models</b> - библиотека ORM в Djnago.
        </p>
        <table>
            <tr><th>Django</th><th>SQL</th></tr>
            <tr><td>класс Модели</td><td>Таблица</td></tr>
            <tr><td>объект модели</td><td>строка таблицы</td></tr>
            <tr><td>QuerySet</td><td>запрос</td></tr>
        </table>
    </div>
</section>

<section class="slide">
    <div>
        <h2>ORM vs SQL</h2>
        <script type="snippet" lang="python">
            cursor.execute('select * from users where age > 18')
            for user in cursor.fetchall():
                pk, name, age = user
                print name
        </script>
        <script type="snippet" lang="python">
            for user in User.objects.filter(age__gt=18):
                print user.name
        </script>
    </div>
</section>

<section class="slide">
    <div>
        <h2>Модели Django</h2>
        <script type="snippet" lang="python">
            class Post(models.Model):
                title = models.CharField(max_length=255)
                content = models.TextField()
                creation_date = models.DateTimeField(blank=True)
                def __unicode__(self):
                    return self.title
                def get_absolute_url(self):
                    return '/post/%d/' % self.pk
                class Meta:
                    db_table = 'blogposts'
                    ordering = ['-creation_date']
        </script>
    </div>
</section>

<section class="slide">
    <div>
        <h2>Типы полей</h2>
        <table>
            <tr><th>Django</th><th>MySQL</th></tr>
            <tr><td>CharField</td><td>VARCHAR(N)</td></tr>
            <tr><td>EmailField</td><td></td></tr>
            <tr><td>TextField</td><td>LONGTEXT</td></tr>
            <tr><td>BooleanField</td><td>TINYINT(1)</td></tr>
            <tr><td>IntegerField</td><td>INT(11)</td></tr>
            <tr><td>DateField</td><td>DATE</td></tr>
            <tr><td>DateTimeField</td><td>DATETIME</td></tr>
        </table>
    </div>
</section>

<section class="slide">
    <div>
        <h2>Свойства полей</h2>
        <ul>
            <li><code>blank</code> - поле может быть пустым</li>
            <li><code>null</code> - при этом хранится в базе как NULL</li>
            <li><code>max_length</code> - максимальная длина поля</li>
            <li><code>primary_key</code> - это поле - первичный ключ</li>
            <li><code>unique</code> - поле уникально</li>
            <li><code>db_index</code> - для этого поля нужен индекс в базе</li>
            <li><code>default</code> - значение по-умолчанию</li>
            <li><code>choices</code> - варианты значений</li>
        </ul>
    </div>
</section>

<section class="slide shout">
    <div>
        <h2>Связи между моделями</h2>
    </div>
</section>

<section class="slide">
    <div>
        <h2>Связи между моделями</h2>
        <script type="snippet" lang="python">
            class Post(models.Model):
                title = models.CharField(max_length=255)
                # еще поля...

                category = models.ForeignKey(Category, 
                        null=True, on_delete=models.SET_NULL)

                status = models.OneToOneField(PostStatus)

                tags = models.ManyToManyField(Tag)
        </script>       
    </div>
</section>

<section class="slide">
    <div>
        <h2>Реализация в СУБД</h2>
        <img src="{{ site.pictures_url }}/lesson-11/db.png" class="center">
    </div>
</section>

<section class="slide">
    <div>
        <h2>Ограничения внешних ключей</h2>
        Применимо к полям типа <code>ForeignKey</code>, <code>OneToOneField</code>
        <ul>
            <li><code>RESTRICT</code> → <code>models.PROTECT</code></li>
            <li><code>CASCADE</code> → <code>models.CASCADE</code></li>
            <li><code>SET NULL</code> → <code>models.SET_NULL</code></li>
            <li><code>NO ACTION</code> → <code>models.DO_NOTHING</code></li>
        </ul>
    </div>
</section>

<section class="slide">
    <div>
        <h2>Использование отношений в коде</h2>
        <script type="snippet" lang="python">
            # прямое использование
            post = Post.objects.get(pk=1)
            category = post.category       # Category
            category_id = post.category_id # int
            status = post.status           # Status
            status_id = post.status_id     # int
            tags_manager = post.tags       # RelatedManager
            post.tags.all()                # [ Tags ]
            # использование обратного отношения
            category.post_set.all()        # [ Post ]
            tag.post_set.all()             # [ Post ]
        </script>
    </div>
</section>
