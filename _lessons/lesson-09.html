---
num: 9
title: MVC фреймворки (1)
description: "Компоненты MVC. Django как пример MVC фреймворка. Структура Django проекта. Модульность в Djnago: приложения. Конфигурация проектов. Маршрутизация URL. Обратная маршрутизация URL."
---

<section class="slide shout">
    <div>
        <h2>Web приложения</h2>
    </div>
</section>

<section class="slide">
    <div>
        <h2>Основные типы запросов</h2>
        <ul>
            <li><font color="gray">Запросы статических документов</font></li>
            <li>Запросы динамических документов</li>
            <li>Отправка данных форм</li>
            <li>AJAX - запросы</li>
            <li>Запросы к API сайта</li>
            <li><font color="gray">Персистентные соединения</font></li>
        </ul>
    </div>
</section>

<section class="slide">
    <div>
        <h2>Основные задачи</h2>
        <ul>
            <li>Маршрутизация URL</li>
            <li>Парсинг заголовков и параметров запроса</li>
            <li>Хранение состояния (сессии) пользователя</li>
            <li>Выполнение бизнес-логики</li>
            <li>Работа с базами данных</li>
            <li>Генерация HTML страницы или JSON ответа</li>
        </ul>
    </div>
</section>

<section class="slide shout">
    <div>
        <h2>MVC</h2>
    </div>
</section>

<section class="slide">
    <div>
        <img src="{{ site.pictures_url }}/lesson-09/mvc.png" class="place">
    </div>
</section>

<section class="slide">
    <div>
        <h2>Роли компонентов MVC</h2>
        <ul>
            <li>Router - выбор конкретного controller по URL</li>
            <li>Model - реализация бизнес-логики приложения</li>
            <li>Controller - работа с HTTP, связь controller и view </li>
            <li>View - генерация HTML или другого представления</li>
        </ul>
    </div>
</section>

<section class="slide">
    <div>
        <img src="{{ site.pictures_url }}/lesson-09/frameworks.png" class="place">
    </div>
</section>

<section class="slide">
    <div>
        <h2>Плюсы фреймворков</h2>
        <ul>
            <plus>Готовая архитектура</plus>
            <plus>Повторное использование кода</plus>
            <plus>Экономия ресурсов</plus>
            <plus>Участие в Open Source</plus>
            <plus>Проще найти программистов</plus>
            <plus>Проще обучать программистов</plus>
        </ul>
    </div>
</section>

<section class="slide shout">
    <div>
        <h2>Django</h2>
    </div>
</section>

<section class="slide">
    <div>
        <h2>Соглашение о именовании</h2>
        <table>
            <tr><th>MVC</th><th>Django</th></tr>
            <tr><td>Model</td><td>Model</td></tr>
            <tr><td>Router</td><td>urls.py</td></tr>
            <tr><td>Controller</td><td>views</td></tr>
            <tr><td>View</td><td>templates</td></tr>
        </table>
    </div>
</section>

<section class="slide">
    <div>
        <h2>Структура проекта</h2>
        <code>django-admin startproject project</code> - создание проекта.
        <script type="snippet" lang="plain">
            project
            ├── crm
            │   ├── models.py
            │   ├── urls.py
            │   └── views.py
            ├── manage.py
            └── project
            ├── settings.py
            ├── urls.py
            └── wsgi.py
        </script>
    </div>
</section>

<section class="slide">
    <div>
        <h2>Основные файлы проекта</h2>
        <ul>
            <li><code>manage.py</code> - скрипт управления проектом</li>
            <li><code>project/settings.py</code> - настройки</li>
            <li><code>project/urls.py</code> - router, список URL проекта</li>
            <li><code>project/wsgi.py</code> - WSGI приложение, точка входа</li>
            <li><code>crm</code> - Django - приложение</li>
        </ul>
    </div>
</section>

<section class="slide">
    <div>
        <h2>Структура не-open-source проекта</h2>
        <script type="snippet" lang="python">
            anyname
            ├── project
            │   ├── crm
            │   ├── blog
            │   ├── manage.py
            │   └── project
            │       ├── settings.py
            │       ├── urls.py
            │       └── wsgi.py
            ├── templates
            └── static
        </script>
    </div>
</section>

<section class="slide shout">
    <div>
        <h2>Django приложения</h2>
    </div>
</section>

<section class="slide">
    <div>
        <h2>Django приложения</h2>
        <p><b>Приложения</b> - способ распространения кода в Django инфраструктуре.
            В случае, если вы не планируете публиковать ваш код, приложения - это просто способ логической организации кода.</p>
        <p><code>./manage.py startapp crm</code> - создание нового приложения с именем <code>crm</code>. 
            Нужно вызывать из директории проекта.</p>
    </div>
</section>

<section class="slide">
    <div>
        <h2>Структура приложения</h2>
        <script type="snippet" lang="plain">
            ├── templates
            ├── static
            ├── templatetags
            ├── management
            │   └── commands
            ├── migrations
            ├── models.py
            ├── tests.py
            ├── urls.py
            └── views.py
        </script>
    </div>
</section>

<section class="slide">
    <div>
        <h2>Основные файлы приложения</h2>
        <ul>
            <li><code>models.py</code> - файл с моделями, бизнес-логика</li>
            <li><code>views.py</code> - контроллеры</li>
            <li><code>urls.py</code> - URL роутер данного приложения</li>
            <li><code>templates</code> - директория с шаблонами</li>
            <li><code>management/commands</code> - консольные команды приложения</li>
            <li><code>static</code> - CSS, JavaScript, картинки</li>
            <li><code>migrations</code> - миграции для обновления базы данных</li>
        </ul>
    </div>
</section>

<section class="slide shout">
    <div>
        <h2>Конфигурация Django</h2>
    </div>
</section>

<section class="slide">
    <div>
        <h2>Конфиг - просто python модуль</h2>
        <script type="snippet" lang="python">
            # project/project/settings.py
            ROOT_URLCONF = 'project.urls'
            DATABASES = {
                'default': {
                    'ENGINE': 'django.db.backends.sqlite3',
                    'NAME': os.path.join(BASE_DIR, 'db.sqlite3'),
                }
            }
            TEMPLATE_DIRS = (
                BASE_DIR + '/templates',
            )
        </script>
    </div>
</section>

<section class="slide">
    <div>
        <h2>Пути в конфиге</h2>
        Проблемы:
        <ul>
            <li>Проект может быть развернут в любой директории</li>
            <li>Несколько копий проекта на одном сервере</li>
        </ul>
        Решения:
        <ul>
            <li>Абсолютные пути в каждом конфиге</li>
            <li>Переменные окружения, <code>$PROJECT_PATH</code></li>
            <li>Относительные пути</li>
        </ul>
    </div>
</section>

<section class="slide">
    <div>
        <h2>Относительные пути</h2>
        <script type="snippet" lang="python">
            import os.path
            BASE_DIR = os.path.abspath(__file__)
            BASE_DIR = os.path.dirname(BASE_DIR)
            BASE_DIR = os.path.dirname(BASE_DIR)

            TEMPLATE_DIRS = (
                BASE_DIR + '/templates',
            )
            STATIC_ROOT = BASE_DIR + '/static'
        </script>
    </div>
</section>

<section class="slide">
    <div>
        <h2>Паттерн local_settings.py</h2>
        <script type="snippet" lang="python">
            # в конце project/settings.py
            try:
                from ask_pupkin.local_settings import *
            except ImportError:
                pass
        </script>
    </div>
</section>

<section class="slide shout">
    <div>
        <h2>Маршрутизация URL</h2>
    </div>
</section>

<section class="slide">
    <div>
        <h2>Порядок поиска контроллера</h2>
        <ul>
            <li>Django начинает поиск с файла <code>ROOT_URLCONF</code> из настроек</li>
            <li>Загрузив файл, Django использует переменную <code>urlpatterns</code></li>
            <li>Django проходит по всем паттернам до первого совпадения</code></li>
        <li>Если совпадения не найдено - будет возвращен код <nobr><code>404 Not Found</code></nobr></li>
    </ul>
</div>
</section>

<section class="slide">
    <div>
        <h2>Маршрутизация в проекте</h2>
        <script type="snippet" lang="python">
            # project/project/urls.py

            urlpatterns = [
                url(r'^$', 'blog.views.home', name='home'),
                url(r'^', include('blog.urls')),
                url(r'^admin/', include('admin.site.urls')),
            ]
        </script>
    </div>
</section>

<section class="slide">
    <div>
        <h2>Маршрутизация в приложении</h2>
        <script type="snippet" lang="python">
            # project/blog/urls.py
            from blog.views import post_list

            urlpatterns = patterns('blog.views',
                url(r'^$', post_list, name='post-list'),
                url(r'^category/(\d+)/$', 'category_view', 
                            name='post-list-by-category'),
                url(r'^(?P<pk>\d+)/$', 'post_detail', 
                            name='post-detail'),
            )
        </script>
    </div>
</section>

<section class="slide">
    <div>
        <h2>Используемые функции</h2>
        <ul>
            <li><code>url</code> - для передачи именованных параметров</li>
            <li><code>patterns</code> - для добавления префикса к именам</li>
            <li><code>include</code> - включение одного urls.py внутрь другого</li>
        </ul>
    </div>
</section>

<section class="slide">
    <div>
        <h2>Особенности маршрутизации в Django</h2>
        <ul>
            <li>Слеш (<code>/</code>) в начале роутов не указывается</li>
            <li>Можно указывать как имя, так и саму view-функцию</li>
            <li>Роуты описываются с помощью регулярных выражений</li>
            <li>Можно и нужно разносить роуты по приложениям</li>
            <li>Можно и нужно создавать именованные роуты</li>
            <li>Одно действие – один роут – один контроллер</li>
        </ul>
    </div>
</section>

<section class="slide">
    <div>
        <h2>Reverse routing</h2>
        В python коде:
        <script type="snippet" lang="python">
            from django.core.urlresolvers import reverse
            reverse('home')
            reverse('category-view', args=(10,))
            reverse('post-detail', kwargs={'pk': 7})
        </script>
        В шаблоне:
        <script type="snippet" lang="django"> {% raw %}
            {% url 'question-view' question.id %}
        {% endraw %} </script>
    </div>
</section>
